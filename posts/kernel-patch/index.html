<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="My First Commit in the Linux Kernel - Patching a Bug in the binfmt Kernel Component" /><meta property="og:locale" content="en" /><meta name="description" content="Earlier in 2021, about March, my own code got into the Linux kernel! Long story short, I found a bug in some binary execution handling component called binfmt_misc, got to the bottom of it and fixed it, suggested a patch, and it got applied üôÇ" /><meta property="og:description" content="Earlier in 2021, about March, my own code got into the Linux kernel! Long story short, I found a bug in some binary execution handling component called binfmt_misc, got to the bottom of it and fixed it, suggested a patch, and it got applied üôÇ" /><link rel="canonical" href="https://xrl1.sh/posts/kernel-patch/" /><meta property="og:url" content="https://xrl1.sh/posts/kernel-patch/" /><meta property="og:site_name" content="A collection of various tech blabs" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-01-02T23:31:28+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="My First Commit in the Linux Kernel - Patching a Bug in the binfmt Kernel Component" /><meta name="twitter:site" content="@LiorRibak1" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-01-08T21:35:04+02:00","datePublished":"2022-01-02T23:31:28+02:00","description":"Earlier in 2021, about March, my own code got into the Linux kernel! Long story short, I found a bug in some binary execution handling component called binfmt_misc, got to the bottom of it and fixed it, suggested a patch, and it got applied üôÇ","headline":"My First Commit in the Linux Kernel - Patching a Bug in the binfmt Kernel Component","mainEntityOfPage":{"@type":"WebPage","@id":"https://xrl1.sh/posts/kernel-patch/"},"url":"https://xrl1.sh/posts/kernel-patch/"}</script><title>My First Commit in the Linux Kernel - Patching a Bug in the binfmt Kernel Component | A collection of various tech blabs</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="A collection of various tech blabs"><meta name="application-name" content="A collection of various tech blabs"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.1/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.1/dist/jquery.min.js"></script><body data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="https://s.gravatar.com/avatar/d115496ef6de2eec5d128dbc744b8e4d?s=80" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title"> <a href="/">A collection of various tech blabs</a></div><div class="site-subtitle font-italic">Cyber, Linux, ML, and more</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/xrl1" aria-label="github" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/LiorRibak1" aria-label="twitter" target="_blank" rel="noopener noreferrer"> <i class="fab fa-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['liorribak','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>My First Commit in the Linux Kernel - Patching a Bug in the binfmt Kernel Component</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>My First Commit in the Linux Kernel - Patching a Bug in the binfmt Kernel Component</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1641159088" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Jan 2, 2022 </em> </span> <span> Updated <em class="" data-ts="1641670504" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Jan 8, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/LiorRibak1">Lior Ribak</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1506 words"> <em>8 min</em> read</span></div></div></div><div class="post-content"><p>Earlier in 2021, about March, my own code got into the Linux kernel!<br /> Long story short, I found a bug in some binary execution handling component called <code class="language-plaintext highlighter-rouge">binfmt_misc</code>, got to the bottom of it and fixed it, suggested a patch, and it got applied üôÇ</p><p>You can check out the commit here:</p><p><a href="https://github.com/torvalds/linux/commit/e7850f4d844e0acfac7e570af611d89deade3146">https://github.com/torvalds/linux/commit/e7850f4d844e0acfac7e570af611d89deade3146</a></p><p>As a big Linux enthusiast, you can just imagine how excited I‚Äôve been when I saw this:</p><p><a href="/assets/img/kernel-patch/image.png" class="popup img-link "><img data-src="/assets/img/kernel-patch/image.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>Now I can retire in peace.</p><h2 id="the-long-story"><span class="mr-2">The long story</span><a href="#the-long-story" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>I have been working on an educational Linux challenge, and I was trying to understand better the kernel component <code class="language-plaintext highlighter-rouge">binfmt_misc</code> for a specific level I had in mind.</p><p>For a brief explanation on the component, here is its <a href="https://en.wikipedia.org/wiki/Binfmt_misc">Wikipedia page</a>:</p><p><em>‚Äú</em> <strong>binfmt_misc</strong> (<em>Miscellaneous Binary Format</em>) is a capability of the <a href="https://en.wikipedia.org/wiki/Linux_kernel">Linux kernel</a> which allows arbitrary <a href="https://en.wikipedia.org/wiki/Executable_file_format">executable file formats</a> to be recognized and passed to certain <a href="https://en.wikipedia.org/wiki/User_space">user space</a> applications, such as <a href="https://en.wikipedia.org/wiki/Emulator">emulators</a> and <a href="https://en.wikipedia.org/wiki/Virtual_machine">virtual machines</a>.<sup><a href="https://en.wikipedia.org/wiki/Binfmt_misc#cite_note-1">[1]</a></sup> It is one of a number of binary format handlers in the kernel that are involved in preparing a user-space program to run.<em>‚Äú</em></p><p>So this component allows any program to register a custom binary handler, according to some file name extension or file header magic the program defines.<br /> Then, upon the execution of the binary, the <code class="language-plaintext highlighter-rouge">binfmt_misc</code> component will identify the defined program and will pass it the handling of the execution, instead of the more commonly known ELF handler or bash script handler.</p><p>Ok, so I was messing around with registering a new binary handler, by echoing some input into a file named <code class="language-plaintext highlighter-rouge">register</code> in the binfmt filesystem but for some reason.. the process was stuck and didn‚Äôt return. I tried to terminate it brutally with ‚Äúkill -9‚Äù, but to my surprise, it didn‚Äôt respond! A system reboot was necessary to recover this process üòõ</p><p>This is my input in bash:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">echo</span> <span class="s2">":iiiii:E::ii::/proc/sys/fs/binfmt_misc/bla:F"</span> <span class="o">&gt;</span> /proc/sys/fs/binfmt_misc/register
</pre></table></code></div></div><p>As you can see, the kill signal is sent <strong>successfully</strong>, but no response from bash (from which I executed the ‚Äòecho‚Äô builtin command)</p><p><a href="/assets/img/kernel-patch/image-1.png" class="popup img-link "><img data-src="/assets/img/kernel-patch/image-1.png" alt="The immortal bash" class="lazyload" data-proofer-ignore></a> <em>The immortal bash</em> Alrighttt, some interesting behavior from the OS, don‚Äôt you think?</p><h2 id="lets-get-digging"><span class="mr-2">Let‚Äôs get digging</span><a href="#lets-get-digging" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><code class="language-plaintext highlighter-rouge">/proc/sys/fs/binfmt_misc/register</code> isn‚Äôt a standard file in the filesystem.<br /> It is actually a mount point (mounted by default by many standard Linux distributions):</p><p><a href="/assets/img/kernel-patch/image-2.png" class="popup img-link "><img data-src="/assets/img/kernel-patch/image-2.png" alt="binfmt mount point" class="lazyload" data-proofer-ignore></a> <em>binfmt mount point</em> Then binfmt_misc is also.. a filesystem! Or more accurately, a pseudo-filesystem, which implements an interface to communicate with the binfmt kernel component from user-space üôÇ</p><p>Ok, so what is the <code class="language-plaintext highlighter-rouge">register</code> file, and what is the string I just echoed means?<br /> From a <a href="https://www.kernel.org/doc/html/latest/admin-guide/binfmt-misc.html">documentation</a> written by kernel.org:</p><p style="text-align: center;"><i>‚ÄúTo actually register a new binary type, you have to set up a string looking like `:name:type:offset:magic:mask:interpreter:flags` (where you can choose the `:` upon your needs) and echo it to `/proc/sys/fs/binfmt_misc/register`.‚Äù</i></p><p>In my input to the file, the name, type, offset, magic, and mask are non-important, therefore we will take a look at how the interpreter ‚Äì ‚Äúbla‚Äù, a non-existent file in the pseudo-filesystem directory, and flags ‚Äì ‚ÄòF‚Äô (fix binary, more on that later) are all together causing the process freeze</p><h2 id="glasses-on--reading-the-kernel-code"><span class="mr-2">Glasses on ‚Äì reading the kernel code</span><a href="#glasses-on--reading-the-kernel-code" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The code behind the binfmt_misc filesystem resides in the kernel source code under ‚Äúfs/binfmt_misc.c‚Äù. We can manually locate it because ‚Äúfs‚Äù is the folder where most filesystem code resides üòÄ</p><p>Then, we can find the <code class="language-plaintext highlighter-rouge">file_operations</code> struct that is assigned to the file ‚Äúregister‚Äù:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">bm_register_operations</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">write</span>      <span class="o">=</span> <span class="n">bm_register_write</span><span class="p">,</span>
    <span class="p">.</span><span class="n">llseek</span>     <span class="o">=</span> <span class="n">noop_llseek</span><span class="p">,</span>
<span class="p">};</span>

</pre></table></code></div></div><p>So according to the above struct, each time a ‚Äúwrite‚Äù operation is called on the file, the function <code class="language-plaintext highlighter-rouge">bm_register_write</code> will be called.</p><p>After reading the function‚Äôs <a href="https://github.com/torvalds/linux/blob/2347961b11d4079deace3c81dceed460c08a8fc1/fs/binfmt_misc.c#L644">code</a>, there is nothing unusual at a first glance.</p><p>Now let‚Äôs set up a development environment and spawn a kernel debugger, and find out what happens inside the kernel (there are a lot of great guides on how to accomplish this, I used kdbg on <a href="https://medium.com/@daeseok.youn/prepare-the-environment-for-developing-linux-kernel-with-qemu-c55e37ba8ade">qemu with buildroot</a>). Then we find the task (thread in the kernel) in which bash is stuck, and inspect it‚Äôs backtrace:</p><pre><code class="language-stacktrace">0  schedule () at ./arch/x86/include/asm/current.h:15
1  0xffffffff81b51237 in rwsem_down_read_slowpath (sem=0xffff888003b202e0, count=&lt;optimized out&gt;, state=state@entry=2) at kernel/locking/rwsem.c:992
2  0xffffffff81b5150a in __down_read_common (state=2, sem=&lt;optimized out&gt;) at kernel/locking/rwsem.c:1213
3  __down_read (sem=&lt;optimized out&gt;) at kernel/locking/rwsem.c:1222
4  down_read (sem=&lt;optimized out&gt;) at kernel/locking/rwsem.c:1355
5  0xffffffff811ee22a in inode_lock_shared (inode=&lt;optimized out&gt;) at ./include/linux/fs.h:783
6  open_last_lookups (op=0xffffc9000022fe34, file=0xffff888004098600, nd=0xffffc9000022fd10) at fs/namei.c:3177
7  path_openat (nd=nd@entry=0xffffc9000022fd10, op=op@entry=0xffffc9000022fe34, flags=flags@entry=65) at fs/namei.c:3366
8  0xffffffff811efe1c in do_filp_open (dfd=&lt;optimized out&gt;, pathname=pathname@entry=0xffff8880031b9000, op=op@entry=0xffffc9000022fe34) at fs/namei.c:3396
9  0xffffffff811e493f in do_open_execat (fd=fd@entry=-100, name=name@entry=0xffff8880031b9000, flags=&lt;optimized out&gt;, flags@entry=0) at fs/exec.c:913
10 0xffffffff811e4a92 in open_exec (name=&lt;optimized out&gt;) at fs/exec.c:948
11 0xffffffff8124aa84 in bm_register_write (file=&lt;optimized out&gt;, buffer=&lt;optimized out&gt;, count=19, ppos=&lt;optimized out&gt;) at fs/binfmt_misc.c:682
12 0xffffffff811decd2 in vfs_write (file=file@entry=0xffff888004098500, buf=buf@entry=0xa758d0 ":iiiii:E::ii::i:CF
", count=count@entry=19, pos=pos@entry=0xffffc9000022ff10) at fs/read_write.c:603
13 0xffffffff811defda in ksys_write (fd=&lt;optimized out&gt;, buf=0xa758d0 ":iiiii:E::ii::i:CF
", count=19) at fs/read_write.c:658
14 0xffffffff81b49813 in do_syscall_64 (nr=&lt;optimized out&gt;, regs=0xffffc9000022ff58) at arch/x86/entry/common.c:46
15 0xffffffff81c0007c in entry_SYSCALL_64 () at arch/x86/entry/entry_64.S:120
</code></pre><p>We see that indeed the code is stuck in <code class="language-plaintext highlighter-rouge">binfmt_register_write</code> (11) when calling the function <code class="language-plaintext highlighter-rouge">open_exec</code> (10).<br /> Looks like down the road a shared lock is taken, probably on the file passed to <code class="language-plaintext highlighter-rouge">open_exec</code> (I verified it later), but the lock can‚Äôt be obtained, therefore the process waits.</p><p>So who takes a write lock in a manner that causes an actual deadlock? <br /> We should get back to <code class="language-plaintext highlighter-rouge">bm_register_write</code> (only relevant parts):</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bm_register_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
                   <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Node</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span> <span class="o">=</span> <span class="n">file_inode</span><span class="p">(</span><span class="n">file</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">root</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_root</span><span class="p">,</span> <span class="o">*</span><span class="n">dentry</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">e</span> <span class="o">=</span> <span class="n">create_entry</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">...</span>
    <span class="n">inode_lock</span><span class="p">(</span><span class="n">d_inode</span><span class="p">(</span><span class="n">root</span><span class="p">));</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="p">...</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MISC_FMT_OPEN_FILE</span><span class="p">)</span> <span class="p">{</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">f</span><span class="p">;</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">open_exec</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">interpreter</span><span class="p">);</span> <span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">f</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
            <span class="n">pr_notice</span><span class="p">(</span><span class="s">"register: failed to install interpreter file %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">interpreter</span><span class="p">);</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">simple_release_fs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bm_mnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry_count</span><span class="p">);</span>
            <span class="n">iput</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
            <span class="n">inode</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
            <span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">e</span><span class="o">-&gt;</span><span class="n">interp_file</span> <span class="o">=</span> <span class="n">f</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="p">...</span>

    <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out2:</span>
    <span class="n">dput</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
<span class="nl">out:</span> <span class="p">(</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">inode_unlock</span><span class="p">(</span><span class="n">d_inode</span><span class="p">(</span><span class="n">root</span><span class="p">));</span>

    <span class="p">...</span>
<span class="p">}</span>
</pre></table></code></div></div><p>In (1), the entry is created, and the flags are populated.</p><p>In (2), a lock is taken on the whole filesystem root (!!!!). Alright, maybe this is it?</p><p>In (3) , we check the flags we provided in our input<br /> We can see in some inner <a href="https://github.com/torvalds/linux/blob/2347961b11d4079deace3c81dceed460c08a8fc1/fs/binfmt_misc.c#L256">code</a> (called somewhere inside <code class="language-plaintext highlighter-rouge">create_entry</code>) that ‚ÄòF‚Äô adds the flag <code class="language-plaintext highlighter-rouge">MISC_FMT_OPEN_FILE</code>, hence the ‚Äúif‚Äù statement is true and we reach the code in (4), which is the only statement that calls <code class="language-plaintext highlighter-rouge">open_exec</code> in our code flow.</p><p>We call <code class="language-plaintext highlighter-rouge">open_exec</code> with an interpreter path inside the filesystem root, and even though the file does not exist, an inner code will try to acquire a read lock, but after a write lock is already locking it, the code will‚Ä¶ wait.</p><p>We can be sure by running <code class="language-plaintext highlighter-rouge">dmesg</code> and observing that the message in (5) has never been reached.</p><p>In (6), the write lock is taken down, which is too late: the task is now waiting inside <code class="language-plaintext highlighter-rouge">open_exec</code> and the function will never return</p><p>In short, a write lock is taken on the filesystem root, and with a specific input we cause the same task to try and read in the same place before the lock is taken down, and a deadlock transpires</p><h2 id="gloves-on--patching-the-code"><span class="mr-2">Gloves on ‚Äì Patching the code</span><a href="#gloves-on--patching-the-code" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>You can see my final patch at the <a href="https://github.com/torvalds/linux/commit/e7850f4d844e0acfac7e570af611d89deade3146#diff-bf2e758056c3a407da85096cc54172c2f8ea3d3e252a6692934d494f30cc5198">kernel‚Äôs Github</a>, which is generally very simple ‚Äì I just moved the ‚Äúif‚Äù block before the code locks the entire kernel, and some small variable definition and freeing accordingly.</p><p>After testing the patch on the qemu environment, I was ready to contribute it to the kernel.</p><p>Then I did the tiresome work to <a href="https://nickdesaulniers.github.io/blog/2017/05/16/submitting-your-first-patch-to-the-linux-kernel-and-responding-to-feedback/">create the patch</a> conforming to the <a href="https://www.kernel.org/doc/html/v4.17/process/submitting-patches.html">guidelines</a> and sent it as an email to the Linux Kernel Mailing List, and.. nothing.</p><p>It was the end of December 2020, and I thought that maybe the holidays are causing a delay, but January came by, and my mail wasn‚Äôt even acked by anyone.<br /> I sent another email, but still nothing‚Ä¶</p><p>Each section in the Kernel code has a dedicated maintainer, but the maintainer of <code class="language-plaintext highlighter-rouge">binfmt_misc.c</code> just didn‚Äôt reply ü§∑‚Äç‚ôÇÔ∏è</p><p>I continued with my life, and then, in February 2021, I noticed that someone else has inserted a commit into <code class="language-plaintext highlighter-rouge">binfmt_misc.c</code> !<br /> I emailed the guy (‚Ä´deller@gmx.de‚Ä¨‚Äè) personally and asked for help, and he pointed out that this code section isn‚Äôt really maintained and I should address a guy named Andrew Morton, who picks up random patches and forwards them to Linus.</p><p>Deller gave me a small fix to the code and forwarded it to Andrew with an ack.</p><p>Then after a couple of days, and after hopping through many different git repositories (the Linux kernel code process is very complicated) my code got into the kernel, and acked by the one and only, Linus Torvalds!</p><p>The public email exchange can be found in the Linux Kernel Mailing List archive starting <a href="https://lkml.org/lkml/2020/12/24/121">here</a></p><p>But retirement is too early, so I hope this is not my last patch üòâ</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/linux/'>Linux</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/linux/" class="post-tag no-text-decoration" >Linux</a> <a href="/tags/kernel/" class="post-tag no-text-decoration" >kernel</a> <a href="/tags/binfmt-misc/" class="post-tag no-text-decoration" >binfmt_misc</a> <a href="/tags/submit-patch/" class="post-tag no-text-decoration" >Submit Patch</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=My%20First%20Commit%20in%20the%20Linux%20Kernel%20-%20Patching%20a%20Bug%20in%20the%20binfmt%20Kernel%20Component%20-%20A%20collection%20of%20various%20tech%20blabs&url=https%3A%2F%2Fxrl1.sh%2Fposts%2Fkernel-patch%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=My%20First%20Commit%20in%20the%20Linux%20Kernel%20-%20Patching%20a%20Bug%20in%20the%20binfmt%20Kernel%20Component%20-%20A%20collection%20of%20various%20tech%20blabs&u=https%3A%2F%2Fxrl1.sh%2Fposts%2Fkernel-patch%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=My%20First%20Commit%20in%20the%20Linux%20Kernel%20-%20Patching%20a%20Bug%20in%20the%20binfmt%20Kernel%20Component%20-%20A%20collection%20of%20various%20tech%20blabs&url=https%3A%2F%2Fxrl1.sh%2Fposts%2Fkernel-patch%2F" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recent Update</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/coordinates-model-with-ChatGPT/">Creating Real-World AI Models by Newbies With ChatGPT</a><li><a href="/posts/how-to-send-big-data/">Big data for Dummy Developers - Step Into Foreign Territory</a><li><a href="/posts/kernel-patch/">My First Commit in the Linux Kernel - Patching a Bug in the binfmt Kernel Component</a><li><a href="/posts/Leveraging-LD_AUDIT/">Leveraging LD_AUDIT to Beat the Traditional Linux Library Preloading Technique - repost</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ai/">AI</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/llm/">LLM</a> <a class="post-tag" href="/tags/machine-learning/">Machine Learning</a> <a class="post-tag" href="/tags/bert/">BERT</a> <a class="post-tag" href="/tags/big-data/">Big Data</a> <a class="post-tag" href="/tags/binfmt-misc/">binfmt_misc</a> <a class="post-tag" href="/tags/chatgpt/">ChatGPT</a> <a class="post-tag" href="/tags/consistency/">Consistency</a> <a class="post-tag" href="/tags/coordinates/">coordinates</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div><script src="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.js"></script></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Leveraging-LD_AUDIT/"><div class="card-body"> <em class="small" data-ts="1641338540" data-df="ll" > Jan 5, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Leveraging LD_AUDIT to Beat the Traditional Linux Library Preloading Technique - repost</h3><div class="text-muted small"><p> About a year ago I while I was going through the code of the standard library loader, ld.so, I encountered an interesting auditing API. Soon I found out that this API is very handy and powerful - ...</p></div></div></a></div><div class="card"> <a href="/posts/kernel_tracer/"><div class="card-body"> <em class="small" data-ts="1641839962" data-df="ll" > Jan 10, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>My Simple Utility for Kernel Function Graph Tracing</h3><div class="text-muted small"><p> Have you ever wondered how come strace is such a popular tool, while all it shows you are only the syscalls a program is calling and nothing more? Well, in most cases it‚Äôs enough. But sometimes, e...</p></div></div></a></div><div class="card"> <a href="/posts/the-next-generation-of-sensitive-information-detection/"><div class="card-body"> <em class="small" data-ts="1733004000" data-df="ll" > Dec 1, 2024 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>The Next Generation of Sensitive Data Detection</h3><div class="text-muted small"><p> About 6 months ago, I resigned from my comfortable Engineering Manager position to explore new opportunities. After some rest and vacation time, I wondered what to do next. I have always been draw...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"><div class="btn btn-outline-primary disabled" prompt="Older"><p>-</p></div><a href="/posts/Leveraging-LD_AUDIT/" class="btn btn-outline-primary" prompt="Newer"><p>Leveraging LD_AUDIT to Beat the Traditional Linux Library Preloading Technique - repost</p></a></div><div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small">Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = 'https://xrl1.sh/posts/kernel-patch/'; this.page.identifier = '/posts/kernel-patch/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver( function (entries) { if (entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://xrl1.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] } ); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* Disqus hasn't been loaded */ if (typeof DISQUS === 'undefined') { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } } if (document.querySelector('.mode-toggle')) { window.addEventListener('message', reloadDisqus); } </script></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ai/">AI</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/llm/">LLM</a> <a class="post-tag" href="/tags/machine-learning/">Machine Learning</a> <a class="post-tag" href="/tags/bert/">BERT</a> <a class="post-tag" href="/tags/big-data/">Big Data</a> <a class="post-tag" href="/tags/binfmt-misc/">binfmt_misc</a> <a class="post-tag" href="/tags/chatgpt/">ChatGPT</a> <a class="post-tag" href="/tags/consistency/">Consistency</a> <a class="post-tag" href="/tags/coordinates/">coordinates</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"><div class="footer-left"><p class="mb-0"> ¬© 2024 <a href="https://twitter.com/LiorRibak1">Lior Ribak</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0">Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></div></footer><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1.11.6/dayjs.min.js,npm/dayjs@1.11.6/locale/en.min.js,npm/dayjs@1.11.6/plugin/relativeTime.min.js,npm/dayjs@1.11.6/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/unregister.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-EZF1CWYJ1T"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-EZF1CWYJ1T'); }); </script>
